{% extends 'base_test.html' %}

{% block additional-headers %}

    <link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap-multiselect.css" type="text/css"/>

    <!--Data Table -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}assets/plugins/select2/select2_metro.css"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}assets/plugins/data-tables/DT_bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="/static/js/DataTables/datatables.css">


    <style type="text/css">


        .scroll {

            overflow-y: auto;
            overflow-x: hidden;
            height: 200px;
        }

        .align {
            text-align: center;
        }

        .textAlign {
            text-align: left;
        }

        .exportMargin {

            margin-bottom: 2%;
        }

        .form-label {
            font-weight: 600 !important;
            font-size: 24px;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #222;
        }

    </style>

{% endblock %}


{% block content %}


    <h3 class="form-label">Feedback List </h3>

    <div class="row">
        <div class="col-md-4" style="float: left">
            <div class="form-group">
                <a class="btn btn-success red-custom" href="/hhmodule/eyfw/add_new/">New Feedback</a>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-md-3">
            <div class="form-group">
                <label class="control-label">Date </label>
                <input class="form-control " type="date" id="fromDate" value="{{ initialFromDate }}">
            </div>
        </div>

        <div class="col-md-3">
            <div class="form-group">
                <label class="control-label"> To </label>
                <input class="form-control " type="date" id="toDate" value="{{ initialToDate }}">
            </div>
        </div>

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label">Gender </label>
                <select class="  form-control " type="select" id="gender">
                    <option>Select Any</option>
                    <option value="%">All</option>
                    <option value="1">Male</option>
                    <option value="2">Female</option>
                    <option value="3">Other</option>
                </select>
            </div>
        </div>

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label">Feedback Type </label>
                <select class="  form-control  " type="select" id="feedbackType">
                    <option>Select Any</option>
                    <option value="%">All</option>
                    <option value="1">Sensitive</option>
                    <option value="2">Urgent</option>
                    <option value="3">Normal</option>
                </select>
            </div>
        </div>

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label">Feedback Status </label>
                <select class="  form-control  " type="select" id="feedbackStatus">
                    <option>Select Any</option>
                    <option value="%">All</option>
                    <option value="1">Managed</option>
                    <option value="2">Referred</option>
                    <option value="3">Under Process</option>
                    <option value="4">Not responded</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label">District </label>
                <select class="  form-control " type="select" id="district">
                    <option>Select Any</option>
                    <option value="%"> All</option>
                    {% for list in dist_List %}
                        <option value={{ list.0 }}>{{ list.1 }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label">Upazila </label>
                <select class="  form-control " type="select" id="upazila">
                    <option>Select Any</option>
                </select>
            </div>
        </div>

        <div class="col-md-2">
            <div class="from -group">
                <label class="control-label"> Union </label>
                <select class="  form-control  " type="select" id="union">
                    <option>Select Any</option>
                </select>
            </div>
        </div>

        <div class="col-md-2" style="visibility: hidden">
            <div class="from -group">
                <label class="control-label"> Ward </label>
                <select class="  form-control  " type="select" id="ward">
                    <option>Select Any</option>
                </select>
            </div>
        </div>


        <div class="col-md-2">

        </div>

        <!--
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="control-label"> Search </label>
                        <input class="form-control " type="text" id=" search">
                    </div>
                </div>
        -->
    </div>

    <div class=" row">
        <div class="col-md-12 ">
            <br>
            <br>

        </div>

    </div>


{#    <div class="row text-right">#}
{#		<button data-toggle="modal" data-target="#export-modal" class="btn btn-primary">Options</button>#}
{#	</div>#}
{##}
{#	<div class="row">#}
{#	    <div class="modal fade" id="export-modal" tabindex="-1" role="dialog">#}
{#	        <div class="modal-dialog" role="document">#}
{#	            <div class="modal-content">#}
{#	                <div class="modal-header">#}
{#	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">X</span></button>#}
{#	                    <h4 class="modal-title">Options</h4>#}
{#	                </div>#}
{#	                <div class="modal-body">#}
{#	                    <p>How would you like to export?</p>#}
{#	                    <button type="button" class="btn btn-primary">Excel</button>#}
{#	                    <button type="button" class="btn btn-success">PDF</button>#}
{#	                    <button type="button" class="btn btn-danger">Copy</button>#}
{#	                </div>#}
{#	            </div><!-- /.modal-content -->#}
{#	        </div><!-- /.modal-dialog -->#}
{#	    </div><!-- /.modal -->#}
{##}
{##}
{#	</div>#}



    <div class="row">

        <div class="col-md-12 ">

            <table id="feedback_list_table"
                   class="table table-bordered table-hover exportMargin">
                <caption class="textAlign">


                </caption>
                <thead>

                </thead>
                <tbody>

                </tbody>
            </table>

        </div>


    </div>




            <!-- MOdal of Delete -->

    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Delete Confirmation</h4>
                </div>
                <div class="modal-body">
                    Do you want to delete this Content ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" onclick="getFeedbackDelete()" class="btn btn-danger btn-ok" data-dismiss="modal">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block additional-javascript %}

    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-multiselect.js"></script>


    <!--Data Table -->
    <!--  <script type="text/javascript" src="{{ STATIC_URL }}assets/plugins/data-tables/jquery.dataTables.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/plugins/data-tables/DT_bootstrap.js"></script>
    <script type="text/javascript" src="/static/js/DataTables/datatables.js"></script>
  -->

    <!--datatable -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.3.1/js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/pdfmake.min.js"></script>
    <script type="text/javascript" src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/vfs_fonts.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.3.1/js/buttons.print.min.js"></script>
    <!--datatable ended-->



    <script type="text/javascript" src="/static/js/custom_data_view.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-datepicker.js"></script>

            <!-- Bootbox -->
    <script type="text/javascript" src="/static/js/bootbox.min.js"></script>





    <script>


        // Variable for getting value

        var id_string = '{{ id_string|safe  }}'
        var username = '{{ username | safe }}'
        var form_creator = '{{ form_creator | safe }}'


        var fromDate = $('#fromDate').val()
        var toDate = $('#toDate').val()
        var gender = ''
        var feedbackType = ''
        var feedbackStatus = ''
        var district = ''
        var upazila = ''
        var union = ''
        var ward = ''
        var tableData = ''

        // On page load

        $(document).ready(function () {
            gender = '%'
            feedbackType = '%'
            feedbackStatus = '%'
            district = '%'
            upazila = '%'
            union = '%'
            ward = '%'

            makingTableWithAjaxCall()


        });


                //  Delete Batch From Table Row --- (Start)

        function getFeedbackDelete() {


            $.ajax({
                type: 'POST',
                url: '/hhmodule/eyfw/getFeefbackDelete/',
                data: {
                    'selecteDID': selecteDID
                },
                success: function (data) {

                    // alert sms
                    bootbox.alert("Content has deleted Successfully");
                    setTimeout(function () {
                        // that's enough of that
                        bootbox.hideAll();
                    }, 1500);


                    $('#feedback_list_table').DataTable().destroy()
                    makingTableWithAjaxCall()
                    //  location.reload();

                }

            });

        }


        //  Delete Batch From Table Row --- (End)



        // Making Table with Ajax call --------

        function makingTableWithAjaxCall() {

            $.ajax({
                type: 'POST',
                url: '/hhmodule/eyfw/generate_feedback_list_data/',
                data: {
                    'fromDate': fromDate,
                    'toDate': toDate,
                    'gender': gender,
                    'feedbackType': feedbackType,
                    'feedbackStatus': feedbackStatus,
                    'district': district,
                    'upazila': upazila,
                    'union': union,
                    'ward': ward
                },
                success: function (data) {

                    tableData = data.jsonFeedbackList

                    generateFeedbackTable(tableData, id_string, username , form_creator);
                }

            });

        }


        // Filtering Of Field ***********

        $(document).on("change", "#fromDate", function () {
            fromDate = $(this).val()
            reDataTable()
        });
        $(document).on("change", "#toDate", function () {
            toDate = $(this).val()
            reDataTable()
        });

        $(document).on("change", "#gender", function () {
            gender = $(this).val()
            reDataTable()
        });
        $(document).on("change", "#feedbackType", function () {
            feedbackType = $(this).val()
            reDataTable()
        });
        $(document).on("change", "#feedbackStatus", function () {
            feedbackStatus = $(this).val()
            reDataTable()
        });
        $(document).on("change", "#district", function () {
            district = $(this).val()

            $.ajax({
                type: 'POST',
                url: '/hhmodule/eyfw/add_new/getUpazilas_jq/',
                data: {

                    'district': district,
                },
                success: function (data) {
                    list = JSON.parse(data)

                    $('#upazila').find('option').remove()
                    $('#upazila').append('<option>Select Any </option><option value = "%">All</option>')
                    for (var i = 0; i < list.upazila_List.length; i++) {
                        $('#upazila').append('<option value = ' + list.upazila_List[i][0] + '>' + list.upazila_List[i][1] + '</option>')
                    }
                }

            });

            reDataTable()
        });

        $(document).on("change", "#upazila", function () {
            upazila = $(this).val()
            $.ajax({
                type: 'POST',
                url: '/hhmodule/eyfw/add_new/getUnions_jq/',
                data: {

                    'upazila': upazila,
                },
                success: function (data) {
                    list = JSON.parse(data)

                    $('#union').find('option').remove()
                    $('#union').append('<option>Select Any </option> <option value = "%">All </option>')

                    for (var i = 0; i < list.union_List.length; i++) {
                        $('#union').append('<option value = ' + list.union_List[i][0] + '>' + list.union_List[i][1] + '</option>')
                    }
                }

            });
            reDataTable()
        });
        $(document).on("change", "#union", function () {
            union = $(this).val()
            reDataTable()
        });
        $(document).on("change", "#ward", function () {
            ward = $(this).val()
            reDataTable()
        });


        // Function for Recreating DataTale After Filter

        function reDataTable() {

            $('#feedback_list_table').DataTable().destroy()
         //   $('#feedback_list_table').css("visibility", 'hidden')
            makingTableWithAjaxCall()

        }


        // Function for Generating Table


        function generateFeedbackTable(tableData, id_string, username , form_creator) {

            var thead = ''
            thead += '<tr> <th>Feedback ID</th> <th>Name</th> <th>Complaint Date</th> <th>District</th> <th>Upazila</th> <th>Union</th> <th>Gender</th> <th>Type</th> <th>Status</th> <th></th> <th></th><th></th> </tr>'

            var tbody = ''
            for (var i = 0; i < tableData.length; i++) {


                viewLink = '/' + form_creator + '/' + 'forms' + '/' + id_string + '/' + 'instance' + '/' + '?s_id=' + tableData[i].id + '#/' + tableData[i].id
                editlink = '/hhmodule/eyfw/add_new_' + id_string + '/' + id_string + '/' + tableData[i].id
                followUpLink = '/hhmodule/eyfw/add_followUp_' + id_string + '/' + id_string + '/' + tableData[i].id
                console.log(viewLink)


                if (tableData[i].gender == 1) tableData[i].gender = 'Male'
                else if (tableData[i].gender == 2) tableData[i].gender = 'Female'
                else if (tableData[i].gender == 3) tableData[i].gender = 'Other'

                if (tableData[i].feedback_status == 1) tableData[i].feedback_status = 'Managed'
                else if (tableData[i].feedback_status == 3) tableData[i].feedback_status = 'Under Process'
                else if (tableData[i].feedback_status == 2) tableData[i].feedback_status = 'Referred'
                else if (tableData[i].feedback_status == 4) tableData[i].feedback_status = 'Not responded'

                tbody += '<tr>'
                tbody += '<td>' + tableData[i].id + '</td><td>' + tableData[i].name + '</td> <td>' + tableData[i].date_complain + '</td> <td>' + tableData[i].district + '</td> <td>' + tableData[i].upazila + '</td> <td>' + tableData[i].union + '</td> <td>' + tableData[i].gender + '</td> <td>' + tableData[i].feedback_type + '</td> <td>' + tableData[i].feedback_status + '</td> <td><a href="' + viewLink + '" class="btn btn-info" role="button">View</a></td> <td><a href="' + editlink + '" class="btn btn-info" role="button">Edit</a></td><td><button id="deleteKMP" value = "' + tableData[i].id + '" type="button" class="btn red-custom"  data-toggle="modal" data-target="#confirm-delete">Delete</button></td>'
                tbody += '</tr>'

            }


            $('#feedback_list_table').find('thead').html(thead)
            $('#feedback_list_table').find('tbody').html(tbody)

            // $('#feedback_list_table').DataTable()
            $('#feedback_list_table').dataTable({
                "retrieve": true,
                "bFilter": true,
                "paging": true,
                "scrollCollapse": true,
                select: true,
                // dom: 'Bfrtip',
                dom: 'Blfrtip',
                buttons: [{extend: 'excel', text: "Export Excel", title: 'Feedback List'}],
                ordering: false,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "scrollX": true


            });

            $('#feedback_list_table').css("visibility", 'visible')

        }



        //  Delete  From Table Row --- (End)

        $(document).on("click", "tr #deleteKMP", function (e) {
            e.preventDefault();
            selecteDID = $(this).attr("value")


            console.log()
        });

    </script>

{% endblock %}